<script>

function ChoppyFX(numberOfSpaces) {
	this.smoothness = numberOfSpaces;
}

ChoppyFX.prototype.get = function(audivi, transform, sampleNum) {
	var samplesPerSecond = audivi.audioContext.sampleRate;

	return (sampleNum % (samplesPerSecond / this.smoothness)) > (samplesPerSecond / (this.smoothness * 2)) ? 1 : 0;
}

function FadeInFX() {

}

FadeInFX.prototype.get = function(audivi, transform, sampleNum) {
	return sampleNum / (transform.duration * audivi.audioContext.sampleRate);
}

function FadeOutFX() {

}

FadeOutFX.prototype.get = function(audivi, transform, sampleNum) {
	return 1 - (sampleNum / (transform.duration * audivi.audioContext.sampleRate));
}

function Transform(duration, frequency) {
	this.rawAmplitude = 1;
	this.rawFrequency = frequency ? frequency : 1;
	this.amplitudeFX = [];
	this.frequencyFX = [];
	this.duration = duration ? duration : 0;
}

Transform.prototype.addAmplitudeEffect = function(fx) {
	this.amplitudeFX.push(fx);
	return this.amplitudeFX.length - 1;
}

Transform.prototype.addFrequencyEffect = function(fx) {
	this.frequencyFX.push(fx);
	return this.frequencyFX.length - 1;
}

Transform.prototype.getAmplitude = function(audivi, sampleNum) {
	var amplitude = this.rawAmplitude;

	for(var i = 0; i < this.amplitudeFX.length; ++i) {
		amplitude *= this.amplitudeFX[i].get(audivi, this, sampleNum);
	}

	return amplitude;
}

Transform.prototype.getFrequency = function(audivi, sampleNum) {
	return this.rawFrequency;
}

function generateSquareWave(audivi, transform) {
	var buffer = audivi.createBuffer();
	var samplesPerSecond = audivi.audioContext.sampleRate;
	var samples = transform.duration * samplesPerSecond;

	var access = buffer.getChannelData(0);

	for(var i = 0; i < samples; ++i) {
		var wavelength = (samplesPerSecond / transform.getFrequency(audivi, i));
		access[i] = ((i % wavelength) > (wavelength / 2) ? 0 : 1) * transform.getAmplitude(audivi, i);
	}

	return buffer;
}

function generateSineWave(audivi, transform) {
	var buffer = audivi.createBuffer();
	var samplesPerSecond = audivi.audioContext.sampleRate;
	var samples = transform.duration * samplesPerSecond;

	var access = buffer.getChannelData(0);

	for(var i = 0; i < samples; ++i) {
		access[i] = (Math.sin(i / (samplesPerSecond / 2 / Math.PI / transform.getFrequency(audivi, i)))) * transform.getAmplitude(audivi, i);
	}

	return buffer;
}

function generateTriangleWave(audivi, transform) {
	var buffer = audivi.createBuffer();
	var samplesPerSecond = audivi.audioContext.sampleRate;
	var samples = transform.duration * samplesPerSecond;

	var access = buffer.getChannelData(0);

	for(var i = 0; i < samples; ++i) {
		var wavelength = (samplesPerSecond / transform.getFrequency(audivi, i));
		access[i] = ((i % wavelength) > (wavelength / 2) ? 1 - ((i % wavelength) - (wavelength / 2)) / (wavelength / 2) : (i % wavelength) / (wavelength / 2)) * transform.getAmplitude(audivi, i);
	}
	
	return buffer;
}

function generateSawtoothWave(audivi, transform) {
	var buffer = audivi.createBuffer();
	var samplesPerSecond = audivi.audioContext.sampleRate;
	var samples = transform.duration * samplesPerSecond;

	var access = buffer.getChannelData(0);

	for(var i = 0; i < samples; ++i) {
		var wavelength = (samplesPerSecond / transform.getFrequency(audivi, i));
		access[i] = (-1 + 2 * ( (i % wavelength) / wavelength)) * transform.getAmplitude(audivi, i);
	}

	return buffer;
}

function Audivi(audioContext) {
	this.audioContext = audioContext ? audioContext : new AudioContext();
	this.sequences = [];
}

Audivi.prototype.createBuffer = function() {
	return this.audioContext.createBuffer(1, this.audioContext.sampleRate, this.audioContext.sampleRate);
}

Audivi.prototype.sequence = function(time, buffer) {
	this.sequences.push({
		time: time,
		buffer: buffer
	});
}

Audivi.prototype.playSequence = function() {
	for(var i = 0; i < this.sequences.length; ++i) {
		this.play(this.sequences[i].time, this.sequences[i].buffer);
	}
}

Audivi.prototype.play = function(time, buffer) {
	var source = this.audioContext.createBufferSource();
	source.buffer = buffer;
	source.connect(this.audioContext.destination);
	source.start(time);
}

function audite(sound) { // plural imperative of audio, audire, literally Latin for "Hear Ye"
	var instance = new Audivi(this.audioContext);
	sound(instance);
	instance.playSequence();
}

var audioContext = new AudioContext();
audite.prototype.audioContext = audioContext;

</script>

<script>
// neat little sound effect to demonstrate some of the features of Audite

audite(
	function(audivi) {
		var transform = new Transform(1, 750);

		transform.addAmplitudeEffect(new ChoppyFX(3));
		transform.addAmplitudeEffect(new FadeInFX());

		audivi.sequence(0, generateSineWave(audivi, transform)); 

		transform.amplitudeFX = [];
		transform.addAmplitudeEffect(new ChoppyFX(10));
		transform.addAmplitudeEffect(new FadeOutFX());

		audivi.sequence(1, generateSineWave(audivi, new Transform(0.7, 300)));
		audivi.sequence(1.8, generateSineWave(audivi, transform));
	}
);


</script>